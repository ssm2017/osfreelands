<?php

/**
 * @package    osFreeLands
 * @copyright Copyright (C) 2013 Wene - ssm2017 Binder ( S.Massiaux ). All rights reserved.
 * @license   GNU/GPL, http://www.gnu.org/licenses/gpl-2.0.html
 * osFreeLands is free software. This version may have been modified pursuant
 * to the GNU General Public License, and as distributed it includes or
 * is derivative of works licensed under the GNU General Public License or
 * other free or open source software licenses.
 */

/**
 * Implements hook_menu().
 */
function osfreelands_menu() {
	$items = array();
	$items['admin/config/metaverse-framework/osfreelands'] = array(
		'title' => 'osFreeLands',
		'description' => 'Settings for the osfreelands module.',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('osfreelands_settings'),
		'access arguments' => array('administer site configuration'),
		'type' => MENU_NORMAL_ITEM,
	);
	$items['osfreelands/terminals/update/%'] = array(
		'title' => 'Update terminal',
		'type' => MENU_CALLBACK,
		'page callback' => 'osfreelands_update_terminal',
		'page arguments' => array(3),
		'access callback' => TRUE,
		'file' => 'osfreelands_terminals.inc'
	);
	return $items;
}

/**
 * Admin settings
 */
function osfreelands_settings() {
	$form = array();
	$form['osfreelands_password_fieldset'] = array(
		'#type' => 'fieldset',
		'#title' => t('Password'),
		'#collapsible' => FALSE,
		'#collapsed' => FALSE,
	);
	$form['osfreelands_password_fieldset']['osfreelands_password'] = array(
		'#type' => 'textfield',
		'#title' => t('Password.'),
		'#default_value' => variable_get('osfreelands_password', '0000'),
		'#description' => t("Enter the password to communicate with the boxes."),
	);
	$form['osfreelands_parcels_fieldset'] = array(
		'#type' => 'fieldset',
		'#title' => t('Parcels'),
		'#collapsible' => FALSE,
		'#collapsed' => FALSE,
	);
	$form['osfreelands_parcels_fieldset']['osfreelands_max_parcels_per_user'] = array(
		'#type' => 'textfield',
		'#title' => t('Max parcels per user.'),
		'#size' => 4,
		'#maxlength' => 4,
		'#default_value' => variable_get('osfreelands_max_parcels_per_user', 0),
		'#description' => t("Maximum quantity of parcels a single user can own. (0 means infinite)"),
	);
	$form['osfreelands_parcels_fieldset']['osfreelands_renting_duration'] = array(
		'#type' => 'textfield',
		'#title' => t('Renting duration.'),
		'#size' => 3,
		'#maxlength' => 3,
		'#default_value' => variable_get('osfreelands_renting_duration', 0),
		'#description' => t("Renting duration in days. (0 means infinite)"),
	);
	return system_settings_form($form);
}

/**
 * Implements hook_node_view.
 */
function osfreelands_node_view($node, $build_mode = 'full') {
	if ($build_mode == 'full') {
		switch ($node->type) {
			case 'freelands_terminal':
				module_load_include('inc', 'osfreelands', 'osfreelands_terminals');
				osfreelands_add_update_terminal_button($node);
				break;
			case 'freelands_parcel':
				module_load_include('inc', 'osfreelands', 'osfreelands_parcels');
				osfreelands_add_rent_parcel_button($node);
				break;
		}
	}
}

/**
 * metaverse frameworkd dispatcher
 */
function osfreelands_dispatch($params) {
	$cmd = $params['cmd'];
	$sl = &$params['sl'];
	$args = $params['args'];
	switch ($cmd) {
		case 'save_terminal':
			module_load_include('inc', 'osfreelands', 'osfreelands_terminals');
			osfreelands_inworld_save_terminal($sl, $args);
			break;
		default:
			$sl->response['status'] = FALSE;
			$sl->response['message'] = "Oops! Unknown command: $cmd.";
			break;
	}
}
